<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºæ…§å®¢æœ - Maison d'Yuko</title>

  <!-- âœ… global CSS -->
  <link rel="stylesheet" th:href="@{/homepage/vendor/bootstrap/bootstrap.min.css}">
  <link rel="stylesheet" th:href="@{/homepage/css/style.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- âœ… main CSS -->
  <style>
    /* èŠå¤©å®¤é é¢å°ˆç”¨æ¨£å¼ */
    .chatbot-section { padding: 60px 0; background: #fdf6ef; min-height: 80vh; }
    .chatbot-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .chatbot-header { text-align: center; margin-bottom: 40px; }
    .chatbot-title { font-size: 2.5rem; color: #8B4513; margin-bottom: 10px; }
    .chatbot-subtitle { font-size: 1.1rem; color: #666; margin-bottom: 30px; }
    
    /* èŠå¤©å®¤å®¹å™¨ */
    .chat-container { background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; height: 600px; display: flex; flex-direction: column; }
    
    /* èŠå¤©å®¤æ¨™é¡Œæ¬„ */
    .chat-header { background: linear-gradient(135deg, #8B4513, #d4a574); color: white; padding: 20px; text-align: center; font-size: 1.2rem; font-weight: 600; }
    
    /* èŠå¤©è¨Šæ¯å€åŸŸ */
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 15px; }
    
    /* è¨Šæ¯æ°£æ³¡ */
    .message { max-width: 70%; padding: 12px 16px; border-radius: 18px; line-height: 1.4; font-size: 0.95rem; word-wrap: break-word; animation: fadeInMessage 0.3s ease-in; }
    @keyframes fadeInMessage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* ç”¨æˆ¶è¨Šæ¯ */
    .message.user { background: #8B4513; color: white; align-self: flex-end; border-bottom-right-radius: 6px; }
    
    /* æ©Ÿå™¨äººè¨Šæ¯ */
    .message.bot { background: white; color: #333; align-self: flex-start; border: 1px solid #e0e0e0; border-bottom-left-radius: 6px; position: relative; margin-left: 35px; }
    .message.bot::before { content: "ğŸ±"; position: absolute; left: -45px; top: 50%; transform: translateY(-50%); font-size: 1.4rem; background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 2px solid #d4a574; }
    
    /* æ­¡è¿è¨Šæ¯ */
    .welcome-message { text-align: center; color: #666; font-style: italic; padding: 20px; margin: 0 -20px 0 -20px; background: transparent; transition: all 0.3s ease; }
    .welcome-message.hidden { opacity: 0; transform: translateY(-20px); pointer-events: none; }
    
    /* è¼¸å…¥å€åŸŸ */
    .chat-input-container { padding: 20px; background: white; border-top: 1px solid #e0e0e0; }
    .chat-input-wrapper { display: flex; gap: 10px; align-items: center; }
    .chat-input { flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 1rem; outline: none; transition: border-color 0.3s ease; }
    .chat-input:focus { border-color: #8B4513; }
    .chat-send-btn { background: #8B4513; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; min-width: 80px; }
    .chat-send-btn:hover:not(:disabled) { background: #6d3410; transform: translateY(-1px); }
    .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    
    /* è¼‰å…¥å‹•ç•« */
    .typing-indicator { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: white; border: 1px solid #e0e0e0; border-radius: 18px; border-bottom-left-radius: 6px; max-width: 70%; align-self: flex-start; position: relative; margin-left: 35px; }
    .typing-indicator::before { content: "ğŸ±"; position: absolute; left: -45px; top: 50%; transform: translateY(-50%); font-size: 1.4rem; background: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: 2px solid #d4a574; }
    .typing-text { color: #666; font-style: italic; }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dot { width: 6px; height: 6px; background: #8B4513; border-radius: 50%; animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
    
    /* å¿«æ·å•é¡ŒæŒ‰éˆ• */
    .quick-questions { padding: 15px 20px; background: #f8f8f8; border-top: 1px solid #e0e0e0; }
    .quick-questions-title { font-size: 0.9rem; color: #666; margin-bottom: 10px; text-align: center; }
    .quick-questions-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    .quick-question-btn { background: white; border: 1px solid #d4a574; color: #8B4513; padding: 6px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; }
    .quick-question-btn:hover { background: #d4a574; color: white; }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .chatbot-title { font-size: 2rem; }
      .chat-container { height: 500px; }
      .message { max-width: 85%; }
      .message.bot { margin-left: 20px; }
      .message.bot::before, .typing-indicator::before { left: -30px; width: 24px; height: 24px; font-size: 1.1rem; }
      .chat-input-wrapper { flex-direction: column; }
      .chat-input { margin-bottom: 10px; }
      .quick-questions-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
      .quick-question-btn { text-align: center; }
    }
    @media (min-width: 992px) { .chatbot-container { margin-left: 120px; margin-right: 120px; } }
  </style>
</head>
<body>

  <!-- âœ… header -->
  <div th:replace="~{fragments/header :: header}"></div>

  <!-- âœ… å­é¸å–® Navbar -->
  <nav class="sub-navbar d-flex justify-content-center align-items-center">
    <ul class="nav">
      <li class="nav-item"><a class="nav-link" href="#">é—œæ–¼å¶¼è”»</a></li>
      <li class="nav-item"><a class="nav-link" href="#">æœ€æ–°æ¶ˆæ¯</a></li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" tabindex="0">æ¢ç´¢å¶¼è”»</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">çé¥ˆç¾é¥Œ</a></li>
          <li><a class="dropdown-item" href="#">å¤šå…ƒè¨­æ–½</a></li>
        </ul>
      </li>
      <li class="nav-item"><a class="nav-link" href="#rooms">ç²¾ç·»å®¢æˆ¿</a></li>
      <li class="nav-item"><a class="nav-link" href="#faq">äº¤é€šè³‡è¨Š</a></li>
      <li class="nav-item"><a class="nav-link" href="#footer">è¯çµ¡æˆ‘å€‘</a></li>
      <li class="nav-item"><a class="nav-link" href="#faq">å¸¸è¦‹å•é¡Œ</a></li>
    </ul>
  </nav>

  <!-- âœ… Sticky å³å´æŒ‰éˆ• -->
  <div class="sticky-icons d-none d-lg-block">
    <a href="#"><img th:src="@{/images/icon/bed.svg}" alt="bed" class="icon"/><br>ç·šä¸Šè¨‚æˆ¿</a>
    <a th:href="@{/front-end/shop}"><img th:src="@{/images/icon/bag.svg}" alt="bag" class="icon"/><br>å¸³è™Ÿé¸ç‰©</a>
    <a href="#"><img th:src="@{/images/icon/dish.svg}" alt="dish" class="icon"/><br>é¤å»³è¨‚ä½</a>
  </div>

  <!-- âœ… Main Content -->
  <section class="chatbot-section">
    <div class="chatbot-container">
      
      <!-- é é¢æ¨™é¡Œ -->
      <div class="chatbot-header">
        <h1 class="chatbot-title">æ™ºæ…§å®¢æœ</h1>
        <p class="chatbot-subtitle">æœ‰ä»»ä½•å•é¡Œå—ï¼Ÿæˆ‘ä¾†å›ç­”æ‚¨ï¼</p>
      </div>

      <!-- èŠå¤©å®¤å®¹å™¨ -->
      <div class="chat-container">
        
        <!-- èŠå¤©å®¤æ¨™é¡Œæ¬„ -->
        <div class="chat-header">
          <div>Maison d'Yuko æ™ºæ…§å®¢æœèŠå¤©å®¤</div>
        </div>

        <!-- èŠå¤©è¨Šæ¯å€åŸŸ -->
        <div class="chat-messages" id="chatMessages">
          <div class="message bot">
            æ­¡è¿ä½¿ç”¨ Maison d'Yuko æ™ºæ…§å®¢æœï¼<br>
            æ‚¨å¯ä»¥è©¢å•é—œæ–¼é£¯åº—è¨­æ–½ã€æœå‹™æˆ–å…¶ä»–ç›¸é—œå•é¡Œã€‚
          </div>
        </div>
        
        <!-- å¿«æ·å•é¡Œ -->
        <div class="quick-questions">
          <div class="quick-questions-title">å¸¸è¦‹å•é¡Œ</div>
          <div class="quick-questions-list">
            <button class="quick-question-btn" onclick="sendQuickQuestion('æ—©é¤æ™‚é–“æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ')">æ—©é¤æ™‚é–“</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('æœ‰åœè»Šå ´å—ï¼Ÿ')">åœè»Šå ´</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('å…¥ä½æ™‚é–“æ˜¯å¹¾é»ï¼Ÿ')">å…¥ä½æ™‚é–“</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('æœ‰å…è²»wifiå—ï¼Ÿ')">WiFi</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('æœ‰æ´—è¡£æœå‹™å—ï¼Ÿ')">æ´—è¡£æœå‹™</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('å¥èº«æˆ¿åœ¨å“ªè£¡ï¼Ÿ')">å¥èº«æˆ¿</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('æœ‰æ¸¸æ³³æ± å—ï¼Ÿ')">æ¸¸æ³³æ± </button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('å¯ä»¥å¯„æ”¾è¡Œæå—ï¼Ÿ')">è¡Œæå¯„æ”¾</button>
            <button class="quick-question-btn" onclick="sendQuickQuestion('å¯ä»¥å¸¶å¯µç‰©å—ï¼Ÿ')">å¯µç‰©æ”¿ç­–</button>
          </div>
        </div>

        <!-- è¼¸å…¥å€åŸŸ -->
        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <input type="text" class="chat-input" id="chatInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." maxlength="200">
            <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">ç™¼é€</button>
          </div>
        </div>

      </div>

    </div>
  </section>

  <!-- âœ… Overlay Full Menu -->
  <div class="overlay-menu" id="overlayMenu">
    <div class="overlay-menu-header d-flex justify-content-between align-items-start">
      <div class="overlay-mobile-menu d-flex justify-content-between align-items-center p-3">
        <div class="mb-menu-header">Maison d'Yuko</div>
      </div>
      <div class="overlay-logo-contact mb-5">
        <img th:src="@{/images/logo/logo_hp.png}" alt="logo" class="overlay-logo mb-3" />
        <div class="overlay-title">å¶¼è”»æ¸¡å‡æ‘ Maison d'Yuko</div>
        <div class="overlay-contact">
          <div>+886-7-123-4567</div>
          <div>service@maisondyuko.com</div>
        </div>
      </div>
      <div class="close-btn" id="menuClose">&times;</div>
    </div>
    <div class="overlay-center">
      <div class="overlay-menu-member px-5 mb-5 d-flex justify-content-center">
        <img th:src="@{/images/icon/member.svg}" alt="member" class="text-center" style="padding:0 5px"/>
        <a href="#" class="text-center">æœƒå“¡ç™»å…¥</a>
      </div>
      <div class="px-5 mb-5 d-flex justify-content-between">
        <a href="#" class="text-center"><img th:src="@{/images/icon/menu_bed.svg}" alt="bed" class="menu-icon"/><br>ç·šä¸Šè¨‚æˆ¿</a>
        <a th:href="@{/front-end/shop}" class="text-center"><img th:src="@{/images/icon/menu_bag.svg}" alt="bag" class="menu-icon"/><br>å¸³è™Ÿé¸ç‰©</a>
        <a href="#" class="text-center"><img th:src="@{/images/icon/menu_dish.svg}" alt="dish" class="menu-icon"/><br>é¤å»³è¨‚ä½</a>
      </div>
      <div class="overlay-menu-row d-flex justify-content-center">
        <div class="overlay-menu-col">
          <h5>é—œæ–¼å¶¼è”»</h5>
          <a href="#">å“ç‰Œæ•…äº‹</a>
          <a href="#">ç’°å¢ƒç°¡ä»‹</a>
        </div>
        <div class="overlay-menu-col">
          <h5>æœ€æ–°æ¶ˆæ¯</h5>
          <a th:href="@{/news/notice}">æœ€æ–°å…¬å‘Š</a>
          <a th:href="@{/news/promotion}">æ´»å‹•é€šçŸ¥</a>
          <a th:href="@{/news/news}">åª’é«”å ±å°</a>
        </div>
        <div class="overlay-menu-col">
          <h5>æ¢ç´¢å¶¼è”»</h5>
          <a href="#">çé¥ˆç¾é¥Œ</a>
          <a href="#">è±å¯Œè¨­æ–½</a>
        </div>
        <div class="overlay-menu-col">
          <h5>ç²¾ç·»å®¢æˆ¿</h5>
          <a href="#">è”»é¦™å±…</a>
          <a href="#">æµ·éŸ³å±…</a>
          <a href="#">æ™¨æ›¦ä¹‹åº­</a>
          <a href="#">æœˆå½±è¡Œé¤¨</a>
        </div>
        <div class="overlay-menu-col">
          <h5>å…¶ä»–</h5>
          <a href="#">äº¤é€šè³‡è¨Š</a>
          <a href="#">è¯çµ¡æˆ‘å€‘</a>
          <a href="#">å¸¸è¦‹å•é¡Œ</a>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… footer -->
  <div th:replace="~{fragments/footer :: footer}"></div>

  <!-- âœ… global JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… Main JS -->
  <script>
    // èŠå¤©å®¤ç›¸é—œè®Šæ•¸
    let isWaitingForResponse = false;
    let isFirstMessage = true;
    const chatMessages = $('#chatMessages');
    const chatInput = $('#chatInput');
    const sendBtn = $('#sendBtn');

    // åˆå§‹åŒ–
    $(document).ready(function() {
      initializeEventHandlers();
      // èšç„¦è¼¸å…¥æ¡†
      chatInput.focus();
    });

    // åˆå§‹åŒ–äº‹ä»¶è™•ç†å™¨
    function initializeEventHandlers() {
      // Menu æ”¶åˆåŠŸèƒ½
      $('#menuToggle').on('click', function () {
        $('#overlayMenu').addClass('active');
      });
      $('#menu-Toggle').on('click', function () {
        $('#overlayMenu').addClass('active');
      });
      $('#menuClose').on('click', function () {
        $('#overlayMenu').removeClass('active');
      });

      // è¼¸å…¥æ¡† Enter éµç™¼é€
      chatInput.on('keypress', function(e) {
        if (e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // è¼¸å…¥æ¡†ç‹€æ…‹è®ŠåŒ–
      chatInput.on('input', function() {
        const hasText = $(this).val().trim().length > 0;
        sendBtn.prop('disabled', !hasText || isWaitingForResponse);
      });
    }

    // ç™¼é€è¨Šæ¯
    function sendMessage() {
      const message = chatInput.val().trim();
      if (!message || isWaitingForResponse) return;

      // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
      addMessage(message, 'user');
      
      // æ¸…ç©ºè¼¸å…¥æ¡†
      chatInput.val('');
      updateSendButton();

      // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
      showTypingIndicator();
      
      // ç™¼é€åˆ°å¾Œç«¯
      sendToBot(message);
    }

    // å¿«æ·å•é¡Œ
    function sendQuickQuestion(question) {
      if (isWaitingForResponse) return;
      
      // è¨­ç½®è¼¸å…¥æ¡†çš„å€¼ä¸¦ç™¼é€
      chatInput.val(question);
      sendMessage();
    }

    // ç™¼é€åˆ°æ©Ÿå™¨äºº
    function sendToBot(message) {
      isWaitingForResponse = true;
      updateSendButton();

      $.ajax({
        url: '/api/chatbot',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ message: message }),
        timeout: 10000, // 10ç§’è¶…æ™‚
        success: function(response) {
          hideTypingIndicator();
          addMessage(response.reply || 'æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨ç„¡æ³•å›ç­”æ‚¨çš„å•é¡Œã€‚', 'bot');
        },
        error: function(xhr, status, error) {
          hideTypingIndicator();
          let errorMessage = 'æŠ±æ­‰ï¼Œæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          
          if (status === 'timeout') {
            errorMessage = 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          } else if (xhr.status === 404) {
            errorMessage = 'æœå‹™ä¸å­˜åœ¨ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚';
          } else if (xhr.status >= 500) {
            errorMessage = 'ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          }
          
          addMessage(errorMessage, 'bot');
          console.error('èŠå¤©æ©Ÿå™¨äººéŒ¯èª¤:', error);
        },
        complete: function() {
          isWaitingForResponse = false;
          updateSendButton();
          chatInput.focus();
        }
      });
    }

    // æ·»åŠ è¨Šæ¯åˆ°èŠå¤©å®¤
    function addMessage(message, type) {
   	  // å¦‚æœæ˜¯æ©Ÿå™¨äººè¨Šæ¯ï¼Œå°±å…ˆ escape + æ›è¡Œè½‰æ›
   	  let content = message;
   	  if (type === 'bot') {
   	    content = escapeHtml(message).replace(/\n/g, '<br>');
   	  } else {
   	    content = escapeHtml(message);
   	  }
      const messageDiv = $(`
        <div class="message ${type}">
          ${content}
        </div>
      `);
      
      chatMessages.append(messageDiv);
      scrollToBottom();
    }

    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showTypingIndicator() {
      const typingDiv = $(`
        <div class="typing-indicator" id="typingIndicator">
          <span class="typing-text">æ­£åœ¨è¼¸å…¥</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `);
      
      chatMessages.append(typingDiv);
      scrollToBottom();
    }

    // éš±è—è¼‰å…¥å‹•ç•«
    function hideTypingIndicator() {
      $('#typingIndicator').remove();
    }

    // æ›´æ–°ç™¼é€æŒ‰éˆ•ç‹€æ…‹
    function updateSendButton() {
      const hasText = chatInput.val().trim().length > 0;
      sendBtn.prop('disabled', !hasText || isWaitingForResponse);
      sendBtn.text(isWaitingForResponse ? 'ç™¼é€ä¸­...' : 'ç™¼é€');
    }

    // æ»¾å‹•åˆ°åº•éƒ¨
    function scrollToBottom() {
      chatMessages.animate({
        scrollTop: chatMessages[0].scrollHeight
      }, 300);
    }

    // HTML è½‰ç¾©
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>