<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœƒå“¡é€šçŸ¥ - Maison d'Yuko</title>

  <!-- âœ… global CSS -->
  <link rel="stylesheet" th:href="@{/homepage/vendor/bootstrap/bootstrap.min.css}">
  <link rel="stylesheet" th:href="@{/homepage/css/style.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    integrity="sha512-tS3S5qG0BlhnQROyJXvNjeEM4UpMXHrQfTGmbQ1gKmelCxlSEBUaxhRBj/EFTzpbP4RVSrpEikbmdJobCvhE3g=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- âœ… main CSS -->
  <style>
    /* é€šçŸ¥é é¢å°ˆç”¨æ¨£å¼ */
    .notifications-section { padding: 60px 0; background: #fdf6ef; min-height: 80vh; }
    .notifications-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .notifications-header { text-align: center; margin-bottom: 40px; }
    .notifications-title { font-size: 2.5rem; color: #8B4513; margin-bottom: 10px; }
    .notifications-subtitle { font-size: 1.1rem; color: #666; margin-bottom: 30px; }
    
    /* é€šçŸ¥åˆ—è¡¨å®¹å™¨ */
    .notification-list-wrapper { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 400px; }
    .notification-list { margin: 0; }
    
    /* é€šçŸ¥é …ç›®æ¨£å¼ */
    .notification-item {
      border-bottom: 1px solid #e0e0e0;
      padding: 20px 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      transition: all 0.3s ease;
    }
    
    .notification-item:last-child { border-bottom: none; }
    .notification-item:hover { background-color: #f9f9f9; padding-left: 15px; padding-right: 15px; border-radius: 8px; }
    .notification-content { flex: 1; padding-right: 20px; }
    .notification-title { font-size: 1.2rem; color: #8B4513; margin-bottom: 8px; font-weight: 600; }
    .notification-message { font-size: 1rem; color: #555; line-height: 1.5; margin-bottom: 5px; }
    .notification-item.unread { background-color: #f9f1e9; border-left: 4px solid #d4a574; padding-left: 16px; }
    .notification-item.unread .notification-title { font-weight: bold; color: #6c4d3c; }
    .notification-item.read { opacity: 0.7; }
    .notification-item.read .notification-title { color: #999; }
    .notification-item.read .notification-message { color: #999; }
    .notification-time {
      font-size: 0.9rem;
      color: #777;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    /* æœªè®€æ¨™è¨˜ */
    .unread-badge {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #d4a574;
      border-radius: 50%;
      margin-left: 10px;
    }

    /* åˆ†é æ¨£å¼ */
    .pagination-wrapper { display: flex; justify-content: center; align-items: center; margin-top: 30px; gap: 10px; }
    .pagination-btn { background: white; border: 1px solid #d4a574; color: #8B4513; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; min-width: 40px; text-align: center; }
    .pagination-btn:hover:not(:disabled) { background: #d4a574; color: white; }
    .pagination-btn.active { background: #8B4513; color: white; border-color: #8B4513; }
    .pagination-btn:disabled { background: #f5f5f5; color: #ccc; border-color: #e0e0e0; cursor: not-allowed; }
    .pagination-info { color: #666; font-size: 0.9rem; }

    /* ç„¡è³‡æ–™è¨Šæ¯ */
    .no-data-message { text-align: center; padding: 60px 20px; color: #666; font-size: 1.1rem; }
    .no-data-icon { font-size: 3rem; color: #ddd; margin-bottom: 20px; }

    /* è¼‰å…¥å‹•ç•« */
    .loading { text-align: center; padding: 40px; color: #666; }
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #8B4513; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .notifications-title { font-size: 2rem; }
      .notification-item { flex-direction: column; align-items: flex-start; }
      .notification-content { padding-right: 0; margin-bottom: 10px; }
      .notification-time { align-self: flex-end; }
    }

    @media (min-width: 992px) {
      .notifications-container { margin-left: 90px; margin-right: 90px; }
    }
  </style>
</head>
<body>

  <!-- âœ… header -->
  <div th:replace="~{fragments/header :: header}"></div>

  <!-- âœ… å­é¸å–® Navbar -->
  <nav class="sub-navbar d-flex justify-content-center align-items-center">
    <ul class="nav">
      <li class="nav-item"><a class="nav-link" href="#">é—œæ–¼å¶¼è”»</a></li>
      <li class="nav-item"><a class="nav-link" href="#">æœ€æ–°æ¶ˆæ¯</a></li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" tabindex="0">æ¢ç´¢å¶¼è”»</a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">çé¥ˆç¾é¥Œ</a></li>
          <li><a class="dropdown-item" th:href="@{/facilities}">å¤šå…ƒè¨­æ–½</a></li>
        </ul>
      </li>
      <li class="nav-item"><a class="nav-link" th:href="@{/roomtypes}">ç²¾ç·»å®¢æˆ¿</a></li>
      <li class="nav-item"><a class="nav-link" href="#faq">äº¤é€šè³‡è¨Š</a></li>
      <li class="nav-item"><a class="nav-link" href="#footer">è¯çµ¡æˆ‘å€‘</a></li>
      <li class="nav-item"><a class="nav-link" href="#faq">å¸¸è¦‹å•é¡Œ</a></li>
    </ul>
  </nav>

  <!-- âœ… Sticky å³å´æŒ‰éˆ• -->
  <div class="sticky-icons d-none d-lg-block">
    <a href="#"><img th:src="@{/images/icon/bed.svg}" alt="bed" class="icon"/><br>ç·šä¸Šè¨‚æˆ¿</a>
    <a th:href="@{/front-end/shop}"><img th:src="@{/images/icon/bag.svg}" alt="bag" class="icon"/><br>å¸³è™Ÿé¸ç‰©</a>
    <a href="#"><img th:src="@{/images/icon/dish.svg}" alt="dish" class="icon"/><br>é¤å»³è¨‚ä½</a>
  </div>

  <!-- âœ… Main Content -->
  <section class="notifications-section">
    <div class="notifications-container">
      
      <!-- é é¢æ¨™é¡Œ -->
      <div class="notifications-header">
        <h1 class="notifications-title">æˆ‘çš„é€šçŸ¥</h1>
        <p class="notifications-subtitle">æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰é€šçŸ¥è¨Šæ¯</p>
      </div>

      <!-- é€šçŸ¥åˆ—è¡¨ -->
      <div class="notification-list-wrapper">
        <div id="loadingContainer" class="loading" style="display: none;">
          <div class="loading-spinner"></div>
          <div>æ­£åœ¨è¼‰å…¥é€šçŸ¥...</div>
        </div>
        
        <div id="notificationList" class="notification-list">
          <!-- é€šçŸ¥é …ç›®å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
        </div>
        
        <div id="paginationContainer" class="pagination-wrapper" style="display: none;"></div>
      </div>

    </div>
  </section>

  <!-- âœ… Overlay Full Menu -->
  <div class="overlay-menu" id="overlayMenu">
    <div class="overlay-menu-header d-flex justify-content-between align-items-start">
      <div class="overlay-mobile-menu d-flex justify-content-between align-items-center p-3">
        <div class="mb-menu-header">Maison d'Yuko</div>
      </div>
      <div class="overlay-logo-contact mb-5">
        <img th:src="@{/images/logo/logo_hp.png}" alt="logo" class="overlay-logo mb-3" />
        <div class="overlay-title">å¶¼è”»æ¸¡å‡æ‘ Maison d'Yuko</div>
        <div class="overlay-contact">
          <div>+886-7-123-4567</div>
          <div>service@maisondyuko.com</div>
        </div>
      </div>
      <div class="close-btn" id="menuClose">&times;</div>
    </div>
    <div class="overlay-center">
      <div class="overlay-menu-member px-5 mb-5 d-flex justify-content-center">
        <img th:src="@{/images/icon/member.svg}" alt="member" class="text-center" style="padding:0 5px"/>
        <a href="#" class="text-center">æœƒå“¡ç™»å…¥</a>
      </div>
      <div class="px-5 mb-5 d-flex justify-content-between">
        <a href="#" class="text-center"><img th:src="@{/images/icon/menu_bed.svg}" alt="bed" class="menu-icon"/><br>ç·šä¸Šè¨‚æˆ¿</a>
        <a th:href="@{/front-end/shop}" class="text-center"><img th:src="@{/images/icon/menu_bag.svg}" alt="bag" class="menu-icon"/><br>å¸³è™Ÿé¸ç‰©</a>
        <a href="#" class="text-center"><img th:src="@{/images/icon/menu_dish.svg}" alt="dish" class="menu-icon"/><br>é¤å»³è¨‚ä½</a>
      </div>
      <div class="overlay-menu-row d-flex justify-content-center">
        <div class="overlay-menu-col">
          <h5>é—œæ–¼å¶¼è”»</h5>
          <a href="#">å“ç‰Œæ•…äº‹</a>
          <a href="#">ç’°å¢ƒç°¡ä»‹</a>
        </div>
        <div class="overlay-menu-col">
          <h5>æœ€æ–°æ¶ˆæ¯</h5>
          <a th:href="@{/news/notice}">æœ€æ–°å…¬å‘Š</a>
          <a th:href="@{/news/promotion}">æ´»å‹•é€šçŸ¥</a>
          <a th:href="@{/news/news}">åª’é«”å ±å°</a>
        </div>
        <div class="overlay-menu-col">
          <h5>æ¢ç´¢å¶¼è”»</h5>
          <a href="#">çé¥ˆç¾é¥Œ</a>
          <a th:href="@{/facilities}">è±å¯Œè¨­æ–½</a>
        </div>
        <div class="overlay-menu-col">
          <h5>ç²¾ç·»å®¢æˆ¿</h5>
          <a href="#">è”»é¦™å±…</a>
          <a href="#">æµ·éŸ³å±…</a>
          <a href="#">æ™¨æ›¦ä¹‹åº­</a>
          <a href="#">æœˆå½±è¡Œé¤¨</a>
        </div>
        <div class="overlay-menu-col">
          <h5>å…¶ä»–</h5>
          <a href="#">äº¤é€šè³‡è¨Š</a>
          <a href="#">è¯çµ¡æˆ‘å€‘</a>
          <a href="#">å¸¸è¦‹å•é¡Œ</a>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… footer -->
  <div th:replace="~{fragments/footer :: footer}"></div>

  <!-- âœ… global JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- âœ… Main JS -->
  <script>

    let notifications = [];
    let pageSize = 10;
    let currentPage = 1;

    // åˆå§‹åŒ–
    $(document).ready(function() {
      initializeEventHandlers();
      fetchNotifications();
    });

    // åˆå§‹åŒ–äº‹ä»¶è™•ç†å™¨
    function initializeEventHandlers() {
      // Menu æ”¶åˆåŠŸèƒ½
      $('#menuToggle').on('click', function () {
        $('#overlayMenu').addClass('active');
      });
      $('#menu-Toggle').on('click', function () {
        $('#overlayMenu').addClass('active');
      });
      $('#menuClose').on('click', function () {
        $('#overlayMenu').removeClass('active');
      });
    }

    // ç²å–é€šçŸ¥è³‡æ–™
    function fetchNotifications() {
      showLoading();
      
      $.get(`/api/notifications/member`)
        .done(function (data) {
          hideLoading();
          notifications = data || [];
          renderPage(1);
        })
        .fail(function(xhr, status, error) {
          hideLoading();
          console.error('ç²å–é€šçŸ¥å¤±æ•—:', error);
          showNoDataMessage('ç²å–é€šçŸ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'âŒ');
        });
    }

    // æ¸²æŸ“é é¢
    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageData = notifications.slice(start, end);

      if (pageData.length === 0) {
        showNoDataMessage('ç›®å‰æ²’æœ‰é€šçŸ¥', 'ğŸ“­');
        $('#paginationContainer').hide();
        return;
      }

      let html = "";
      pageData.forEach(n => {
        const createdAt = new Date(n.createdAt);
        const formattedTime = createdAt.toLocaleString("zh-TW");
        const unreadBadge = !n.isRead ? '<span class="unread-badge"></span>' : '';

        html += `
          <div id="notification-${n.notificationId}" 
               class="notification-item ${n.isRead ? 'read' : 'unread'}"
            	   onclick="markAsRead(${n.notificationId}); UpdateUnreadCount();">
            <div class="notification-content">
              <div class="notification-title">
                ${n.title}${unreadBadge}
              </div>
              <div class="notification-message">${n.content}</div>
            </div>
            <div class="notification-time">${formattedTime}</div>
          </div>
        `;
      });

      $("#notificationList").html(html);
      renderPagination();
    }

    // æ¸²æŸ“åˆ†é 
    function renderPagination() {
      const totalPages = Math.ceil(notifications.length / pageSize);
      const container = $('#paginationContainer');
      
      if (totalPages <= 1) {
        container.hide();
        return;
      }
      
      let html = `
        <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''}>
          â€¹ ä¸Šä¸€é 
        </button>
      `;
      
      // é ç¢¼æŒ‰éˆ•
      for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          html += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
              ${i}
            </button>
          `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += '<span class="pagination-info">...</span>';
        }
      }
      
      html += `
        <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
          ä¸‹ä¸€é  â€º
        </button>
      `;
      
      container.html(html).show();
    }

    // æ›é 
    function changePage(page) {
      const totalPages = Math.ceil(notifications.length / pageSize);
      if (page < 1 || page > totalPages) return;
      
      renderPage(page);
      
      // æ»¾å‹•åˆ°é ‚éƒ¨
      $('html, body').animate({
        scrollTop: $('.notifications-section').offset().top - 100
      }, 500);
    }

    // æ¨™è¨˜ç‚ºå·²è®€
    function markAsRead(notificationId) {
      const notificationDiv = $(`#notification-${notificationId}`);
      if (notificationDiv.hasClass("read")) return;

      $.post(`/api/notifications/${notificationId}/read`)
        .done(function (response) {
          if (response === "success") {
            notificationDiv.removeClass("unread").addClass("read");
            notificationDiv.find('.unread-badge').remove();
            const target = notifications.find(n => n.notificationId === notificationId);
            if (target) target.isRead = true;
          } else {
            alert("è¨­ç‚ºå·²è®€å¤±æ•—");
          }
        })
        .fail(function(xhr, status, error) {
          console.error('æ¨™è¨˜å·²è®€å¤±æ•—:', error);
          alert("è¨­ç‚ºå·²è®€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        });
    }
    
    // æ›´æ–°å°éˆ´éºæ•¸å­—
    function UpdateUnreadCount() {
    	setTimeout(() => { // ç‚ºäº†å…ˆç­‰DBæ”¹å®Œæ•¸å­—ï¼Œå†å»è®€å–
	        // å‘¼å« API å–å¾—æœªè®€è¨Šæ¯æ•¸é‡
	        fetch(`/api/notifications/unread-count`)
	            .then(response => {
	                if (!response.ok) throw new Error('Network response was not ok');
	                return response.json();  // å¾Œç«¯APIå›å‚³ long å‹æ•¸å­—çš„è©±é€šå¸¸æœƒæ˜¯ JSON æ ¼å¼
	            })
	            .then(unreadCount => {
	                const badge = document.getElementById('notificationBadge');
	                if (badge) {
	                    if (unreadCount > 0) {
	                        badge.textContent = unreadCount;
	                        badge.style.display = 'flex';  // é¡¯ç¤ºæ•¸å­—å¾½ç« 
	                    } else {
	                        badge.style.display = 'none';  // æ²’æœ‰æœªè®€è¨Šæ¯å°±éš±è—å¾½ç« 
	                    }
	                }
	            })
	            .catch(error => {
	                console.error('å–å¾—æœªè®€è¨Šæ¯æ•¸é‡å¤±æ•—:', error);
	            });
    	}, 500); // å»¶é² 500 æ¯«ç§’
    }
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading() {
      $('#loadingContainer').show();
      $('#notificationList').hide();
      $('#paginationContainer').hide();
    }

    // éš±è—è¼‰å…¥å‹•ç•«
    function hideLoading() {
      $('#loadingContainer').hide();
      $('#notificationList').show();
    }

    // é¡¯ç¤ºç„¡è³‡æ–™è¨Šæ¯
    function showNoDataMessage(message, icon = 'ğŸ“­') {
      const html = `
        <div class="no-data-message">
          <div class="no-data-icon">${icon}</div>
          <div>${message}</div>
        </div>
      `;
      $('#notificationList').html(html);
    }
  </script>
</body>
</html>