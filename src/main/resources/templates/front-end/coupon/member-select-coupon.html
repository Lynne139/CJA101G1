<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>會員折價券查詢｜Maison d'Yuko</title>

  <link rel="stylesheet" th:href="@{/homepage/vendor/bootstrap/bootstrap.min.css}">
  <link rel="stylesheet" th:href="@{/homepage/css/style.css}">
  <style>
    .card-header h5 {
      font-weight: bold;
      margin-bottom: 0;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .pagination button {
      margin: 4px;
      padding: 6px 12px;
      border: none;
      background-color: #ccc;
      cursor: pointer;
    }
    .pagination button.active {
      background-color: #6c4d3c;
      color: white;
    }
  </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<section class="section" style="background-color: #fdf6ef;">
  <div class="container py-5" style="margin-bottom: 100px;">
    <h2 class="text-center mb-5 fw-bold">查詢您的折價券</h2>

    <input type="hidden" id="memberId" th:value="${memberId}" />

    <!-- 查詢條件 -->
    <div class="card shadow-sm mb-5">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">查詢條件</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="queryType" class="form-label">使用狀態</label>
            <select class="form-select" id="queryType" onchange="toggleOrderTypeSelect()">
              <option value="usable">可供使用</option>
              <option value="used">您已使用</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="orderType" class="form-label">適用訂單類型</label>
            <select class="form-select" id="orderType">
              <option value="ROOM_ONLY">訂房訂單</option>
              <option value="PROD_ONLY">商城訂單</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-primary w-100" onclick="queryCoupons()">送出查詢</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 查詢結果 -->
    <div class="card shadow-sm" id="resultCard">
      <div class="card-header bg-secondary text-white">
        <h5 class="mb-0">查詢結果</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle mb-0" id="couponResultTable">
            <thead class="table-light text-center">
              <tr>
                <th>折價券代碼</th>
                <th>折價券名稱</th>
                <th>折扣金額</th>
                <th>到期日</th>
              </tr>
            </thead>
            <tbody id="couponResultBody">
              <tr>
                <td colspan="4" class="text-center text-muted" style="height: 120px;">
                  請選擇查詢條件並按下查詢
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="couponPagination"></div>
      </div>
    </div>
  </div>
</section>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let coupons = [];
  let pageSize = 10;
  let currentPage = 1;

  function toggleOrderTypeSelect() {
    const queryType = document.getElementById('queryType').value;
    const orderTypeSelect = document.getElementById('orderType');

    if (queryType === 'used') {
      orderTypeSelect.innerHTML = '<option value="ALL">全部</option>';
      orderTypeSelect.disabled = true;
    } else {
      orderTypeSelect.innerHTML = 
        <option value="ROOM_ONLY">訂房訂單</option>
        <option value="PROD_ONLY">商城訂單</option>
      ;
      orderTypeSelect.disabled = false;
    }
  }

  function queryCoupons() {
    const memberId = document.getElementById('memberId').value;
    const queryType = document.getElementById('queryType').value;
    const orderType = document.getElementById('orderType').value;

    let url = "";
    if (queryType === 'used') {
      url = /api/member-coupons/${memberId}/used;
    } else {
      url = /api/member-coupons/${memberId}/usable?orderType=${orderType};
    }

    fetch(url)
      .then(response => response.json())
      .then(data => {
        coupons = Array.isArray(data) ? data : [];
        renderCouponPage(1);
      })
      .catch(err => {
        console.error("查詢失敗", err);
        coupons = [];
        renderCouponPage(1);
      });
  }

  function renderCouponPage(page) {
    currentPage = page;
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageData = coupons.slice(start, end);

    const tbody = document.getElementById("couponResultBody");
    tbody.innerHTML = "";

    if (pageData.length === 0) {
      tbody.innerHTML = 
        <tr>
          <td colspan="4" class="text-center text-dark" style="height: 120px;">
            查無符合的折價券
          </td>
        </tr>;
      document.getElementById("couponPagination").innerHTML = "";
      return;
    }

    pageData.forEach(coupon => {
      const row = 
        <tr>
          <td>${coupon.couponCode || ''}</td>
          <td>${coupon.couponName || ''}</td>
          <td>${coupon.discountValue || 0}</td>
          <td>${coupon.expiryDate || ''}</td>
        </tr>
      ;
      tbody.innerHTML += row;
    });

    renderCouponPagination();
  }

  function renderCouponPagination() {
    const totalPages = Math.ceil(coupons.length / pageSize);
    const pagination = document.getElementById("couponPagination");
    pagination.innerHTML = "";

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = (i === currentPage) ? "active" : "";
      btn.onclick = () => renderCouponPage(i);
      pagination.appendChild(btn);
    }
  }
</script>

</body>
</html>