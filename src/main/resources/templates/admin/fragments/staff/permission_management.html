<div th:fragment="content">
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            權限管理
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- 員工列表 -->
                            <div class="col-md-4">
                                <h6>員工列表</h6>
                                <div class="list-group" id="employeeList">
                                    <div th:each="employee : ${employees}" 
                                         class="list-group-item list-group-item-action employee-item"
                                         th:data-employee-id="${employee.employeeId}"
                                         th:onclick="'selectEmployee(' + ${employee.employeeId} + ')'">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong th:text="${employee.name}">員工姓名</strong>
                                                <br>
                                                <small class="text-muted" th:text="'編號: ' + ${employee.employeeId}">員工編號</small>
                                            </div>
                                            <span th:if="${employee.status}" class="badge bg-success">啟用</span>
                                            <span th:unless="${employee.status}" class="badge bg-danger">停用</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 權限設定 -->
                            <div class="col-md-8">
                                <div id="permissionPanel" style="display: none;">
                                    <h6>權限設定 - <span id="selectedEmployeeName"></span></h6>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        請選擇要分配給該員工的權限
                                    </div>
                                    
                                    <form id="permissionForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>功能權限</h6>
                                                <div class="form-check mb-2" th:each="permission : ${allPermissions}">
                                                    <input class="form-check-input permission-checkbox" 
                                                           type="checkbox" 
                                                           th:value="${permission.accessName}"
                                                           th:id="'permission_' + ${permission.accessId}">
                                                    <label class="form-check-label" 
                                                           th:for="'permission_' + ${permission.accessId}"
                                                           th:text="${permission.accessName}">
                                                        權限名稱
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>
                                                儲存權限設定
                                            </button>
                                            <button type="button" class="btn btn-secondary ms-2" onclick="clearSelection()">
                                                <i class="fas fa-times me-2"></i>
                                                清除選擇
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div id="noSelectionPanel" class="text-center py-5">
                                    <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">請選擇員工</h5>
                                    <p class="text-muted">從左側員工列表中選擇要設定權限的員工</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedEmployeeId = null;
        
        function selectEmployee(employeeId) {
            selectedEmployeeId = employeeId;
            
            // 更新UI
            $('.employee-item').removeClass('active');
            $(`.employee-item[data-employee-id="${employeeId}"]`).addClass('active');
            
            // 顯示權限面板
            $('#permissionPanel').show();
            $('#noSelectionPanel').hide();
            
            // 獲取員工權限
            loadEmployeePermissions(employeeId);
        }
        
        function loadEmployeePermissions(employeeId) {
            fetch(`/admin/permission/employee/${employeeId}`)
                .then(response => response.json())
                .then(permissions => {
                    // 清除所有選項
                    $('.permission-checkbox').prop('checked', false);
                    
                    // 勾選員工已有的權限
                    permissions.forEach(permission => {
                        $(`.permission-checkbox[value="${permission}"]`).prop('checked', true);
                    });
                    
                    // 更新員工姓名
                    const employeeName = $(`.employee-item[data-employee-id="${employeeId}"] strong`).text();
                    $('#selectedEmployeeName').text(employeeName);
                })
                .catch(error => {
                    console.error('載入權限失敗:', error);
                    alert('載入權限失敗');
                });
        }
        
        function clearSelection() {
            selectedEmployeeId = null;
            $('.employee-item').removeClass('active');
            $('.permission-checkbox').prop('checked', false);
            $('#permissionPanel').hide();
            $('#noSelectionPanel').show();
        }
        
        // 表單提交
        $('#permissionForm').on('submit', function(e) {
            e.preventDefault();
            
            if (!selectedEmployeeId) {
                alert('請先選擇員工');
                return;
            }
            
            const selectedPermissions = [];
            $('.permission-checkbox:checked').each(function() {
                selectedPermissions.push($(this).val());
            });
            
            // 發送權限更新請求
            fetch(`/admin/permission/employee/${selectedEmployeeId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(selectedPermissions)
            })
            .then(response => response.text())
            .then(result => {
                alert('權限更新成功');
            })
            .catch(error => {
                console.error('權限更新失敗:', error);
                alert('權限更新失敗');
            });
        });
    </script>
</div> 