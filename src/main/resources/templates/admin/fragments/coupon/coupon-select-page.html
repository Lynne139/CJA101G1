<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>查詢折價券</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<link rel="stylesheet" th:href="@{/css/all_admin.css}">
</head>
<body>
	<div class="container py-4">
	    <div class="card mb-4">
	        <div class="card-header d-flex justify-content-between align-items-center">
	            <h4 class="mb-0">查詢折價券</h4>
	            <!-- 新增折價券按鈕 -->
	            <button id="btnAddCoupon" class="btn btn-success btn-sm">新增折價券</button>
	        </div>
	        <div class="card-body">
	            <div class="row g-3">
	                <div class="col-md-4">
	                    <label class="form-label">折價券代碼</label>
	                    <div class="input-group">
	                        <input type="text" id="couponCode" class="form-control" placeholder="輸入折價券代碼">
	                        <button class="btn btn-outline-primary" id="searchByCodeBtn">查詢</button>
	                    </div>
	                </div>
	
	                <div class="col-md-4">
	                    <label class="form-label">折價券名稱</label>
	                    <div class="input-group">
	                        <input type="text" id="couponName" class="form-control" placeholder="輸入折價券名稱">
	                        <button class="btn btn-outline-primary" id="searchByNameBtn">查詢</button>
	                    </div>
	                </div>
	
	                <div class="col-md-4">
	                    <label class="form-label">建立日期區間</label>
	                    <div class="input-group">
	                        <input type="date" id="startDate" class="form-control">
	                        <span class="input-group-text">至</span>
	                        <input type="date" id="endDate" class="form-control">
	                        <button class="btn btn-outline-primary" id="searchByDateBtn">查詢</button>
	                    </div>
	                </div>
	            </div>
	        </div>
	    </div>
	
	    <!-- 查詢結果 -->
	    <div class="card" id="resultSection" style="display: none;">
	        <div class="card-header">
	            <h5 class="mb-0">查詢結果</h5>
	        </div>
	        <div class="card-body">
	            <div class="table-responsive">
	                <table class="table table-bordered align-middle text-center">
	                    <thead class="table-light">
	                        <tr>
	                            <th>折價券編號</th>
	                            <th>名稱</th>
	                            <th>訂單類型</th>
	                            <th>折扣金額</th>
	                            <th>低銷限制</th>
	                            <th>領取開始</th>
	                            <th>領取結束</th>
	                            <th>到期日</th>
	                            <th>建立時間</th>
	                            <th>操作</th> <!-- 修改按鈕欄 -->
	                        </tr>
	                    </thead>
	                    <tbody id="resultBody"></tbody>
	                </table>
	            </div>
	        </div>
	    </div>
	</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const resultSection = document.getElementById('resultSection');

            const orderTypeLabels = {
                1: "限訂房",
                2: "限商城",
                3: "訂房和商城"
            };

            function renderResults(coupons) {
                const tbody = document.getElementById('resultBody');
                // 清空原本的 <tbody>
                tbody.innerHTML = '';
				// 如果是空的 ➜ 顯示「查無資料」紅字
                if (!coupons || coupons.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">查無資料</td></tr>';
                    resultSection.style.display = 'block';
                    return;
                }
				// 否則動態建立 <tr> 資料列、插入對應欄位。
                coupons.forEach(coupon => {
                    let orderTypeText = '未知';

                    if (coupon.orderType == null) {
                        orderTypeText = '未知';
                    } else if (typeof coupon.orderType === 'number') {
                        orderTypeText = orderTypeLabels[coupon.orderType] || '未知';
                    } 
                    // 目前我的後端是傳字串e.g.'ROOM_ONLY'過來的
                    else if (typeof coupon.orderType === 'string') {
                        const key = coupon.orderType.toUpperCase();
                        switch (key) {
                            case 'ROOM_ONLY': orderTypeText = '限訂房'; break;
                            case 'PROD_ONLY': orderTypeText = '限商城'; break;
                            case 'ROOM_AND_PROD': orderTypeText = '訂房和商城'; break;
                            default: orderTypeText = '未知';
                        }
                    } else if (coupon.orderType.label) {
                        orderTypeText = coupon.orderType.label;
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${coupon.couponCode || ''}</td>
                        <td>${coupon.couponName || ''}</td>
                        <td>${orderTypeText}</td>
                        <td>${coupon.discountValue != null ? coupon.discountValue : ''}</td>
                        <td>${coupon.minPurchase != null ? coupon.minPurchase : ''}</td>
                        <td>${coupon.claimStartDate || ''}</td>
                        <td>${coupon.claimEndDate || ''}</td>
                        <td>${coupon.expiryDate || ''}</td>
                        <td>${coupon.createdAt || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-edit" data-code="${coupon.couponCode}">
                                修改
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // 綁定修改按鈕事件，點擊就會跳轉到 /coupon/update/{couponCode}。
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const code = btn.getAttribute('data-code');
                        window.location.href = `/coupon/update/${code}`;
                    });
                });

                resultSection.style.display = 'block';
            }

            document.getElementById('searchByCodeBtn').addEventListener('click', function () {
                const code = document.getElementById('couponCode').value.trim();
                if (!code) return alert("請輸入折價券代碼");
                fetch(`/api/coupons/code/${code}`)
                    .then(response => response.ok ? response.json() : null)
                    .then(data => renderResults(data ? [data] : []));
            });

            document.getElementById('searchByNameBtn').addEventListener('click', function () {
                const name = document.getElementById('couponName').value.trim();
                if (!name) return alert("請輸入折價券名稱");
                fetch(`/api/coupons/name/${name}`)
                    .then(response => response.json())
                    .then(renderResults);
            });

            document.getElementById('searchByDateBtn').addEventListener('click', function () {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (!start || !end) return alert("請選擇日期區間");

                const startDateTime = `${start}T00:00:00`;
                const endDateTime = `${end}T23:59:59`;

                fetch(`/api/coupons/created-range?start=${startDateTime}&end=${endDateTime}`)
                    .then(response => response.json())
                    .then(renderResults);
            });

            // 新增折價券按鈕事件
            document.getElementById('btnAddCoupon').addEventListener('click', () => {
                // 假設新增頁面路徑為 /coupon/add
                window.location.href = '/coupon/add';
            });
        });
    </script>
</body>
</html>
